rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is a participant of a journey
    function isParticipant(journeyId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/journeys/$(journeyId)/participants/$(request.auth.uid));
    }

    // Helper function to check if user is the leader of a journey
    function isLeader(journeyId) {
      let journey = get(/databases/$(database)/documents/journeys/$(journeyId));
      return isAuthenticated() && journey.data.leaderId == request.auth.uid;
    }

    // Helper function to check participant role
    function getParticipantRole(journeyId) {
      let participant = get(/databases/$(database)/documents/journeys/$(journeyId)/participants/$(request.auth.uid));
      return participant.data.role;
    }

    // Users collection - users can only read/write their own profile
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false; // Prevent user deletion via Firestore
    }

    // Journeys collection
    match /journeys/{journeyId} {
      // Read access for participants only
      allow read: if isParticipant(journeyId);

      // Create access for authenticated users
      allow create: if isAuthenticated() &&
                       request.resource.data.leaderId == request.auth.uid;

      // Update access for leader only
      allow update: if isLeader(journeyId);

      // Delete access for leader only
      allow delete: if isLeader(journeyId);

      // Participants subcollection
      match /participants/{participantId} {
        // Read access for all journey participants
        allow read: if isParticipant(journeyId);

        // Write access for leader (invitations)
        allow create: if isLeader(journeyId);

        // Update access for leader or the participant themselves
        allow update: if isLeader(journeyId) ||
                         (isAuthenticated() && request.auth.uid == participantId);

        // Delete access for leader only
        allow delete: if isLeader(journeyId);
      }

      // Locations subcollection
      match /locations/{locationId} {
        // Read access for all journey participants
        allow read: if isParticipant(journeyId);

        // Create access for active participants only
        allow create: if isParticipant(journeyId) &&
                         request.resource.data.userId == request.auth.uid;

        // No update or delete for location history
        allow update: if false;
        allow delete: if false;
      }

      // Lag alerts subcollection
      match /lag_alerts/{alertId} {
        // Read access for all journey participants
        allow read: if isParticipant(journeyId);

        // Write access only for server (no direct client writes)
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      // Notifications subcollection
      match /notifications/{notificationId} {
        // Read access for the recipient only
        allow read: if isAuthenticated() &&
                       resource.data.recipientId == request.auth.uid;

        // Create access only for server
        allow create: if false;

        // Update access for recipient (mark as read)
        allow update: if isAuthenticated() &&
                         resource.data.recipientId == request.auth.uid &&
                         request.resource.data.keys().hasOnly(['read', 'readAt']);

        // Delete access for recipient
        allow delete: if isAuthenticated() &&
                         resource.data.recipientId == request.auth.uid;
      }
    }

    // Analytics collection
    match /analytics/{journeyId} {
      // Read access for participants of the journey
      allow read: if isParticipant(journeyId);

      // Write access only for server
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
