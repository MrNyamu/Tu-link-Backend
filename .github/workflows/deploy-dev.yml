name: Deploy to Development

on:
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Trigger webhook deployment
      run: |
        echo "Triggering deployment via webhook..."
        
        # First, test webhook connectivity
        echo "Testing webhook endpoint connectivity..."
        if ! curl -f -s -m 5 http://${{ secrets.DEV_HOST }}:9000/hooks/deploy-dev -X GET; then
          echo "Warning: Webhook endpoint may not be reachable"
        fi
        
        # Trigger deployment with longer timeout and better error handling
        echo "Sending deployment request..."
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Content-Type: application/json" \
          -H "X-Deploy-Token: ${{ secrets.DEPLOY_WEBHOOK_SECRET }}" \
          -d '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}' \
          --max-time 600 \
          --connect-timeout 10 \
          --retry 2 \
          --retry-delay 5 \
          http://${{ secrets.DEV_HOST }}:9000/hooks/deploy-dev 2>&1)

        # Handle curl exit codes
        CURL_EXIT_CODE=$?
        if [ $CURL_EXIT_CODE -ne 0 ]; then
          echo "Curl failed with exit code: $CURL_EXIT_CODE"
          case $CURL_EXIT_CODE in
            28) echo "Error: Timeout - webhook request took longer than 10 minutes" ;;
            6|7) echo "Error: Could not resolve host or connect to webhook endpoint" ;;
            *) echo "Error: Unexpected curl error" ;;
          esac
          echo "Response received (if any): $RESPONSE"
          exit 1
        fi

        # Parse response
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        echo "Response code: $HTTP_CODE"
        echo "Response body:"
        echo "$BODY"

        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo "Deployment triggered successfully!"
        else
          echo "Deployment webhook failed with HTTP $HTTP_CODE"
          exit 1
        fi

    - name: Health check
      run: |
        echo "Waiting for deployment to complete..."
        sleep 60

        echo "Testing application endpoint..."
        MAX_RETRIES=5
        RETRY_COUNT=0

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f -s https://api.dev.tulink.xyz/health -m 10; then
            echo ""
            echo "Application is responding!"
            exit 0
          else
            echo "Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES failed, retrying in 15s..."
            sleep 15
            RETRY_COUNT=$((RETRY_COUNT + 1))
          fi
        done

        echo "Health check failed after $MAX_RETRIES attempts"
        echo "Deployment may still be in progress - check server logs"
        exit 1
