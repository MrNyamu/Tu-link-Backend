name: Deploy to Development

on:
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Deploy to Digital Ocean Dev Environment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEV_HOST }}
        username: ${{ secrets.DEV_USERNAME }}
        key: ${{ secrets.DEV_SSH_KEY }}
        port: ${{ secrets.DEV_SSH_PORT || '22' }}
        script: |
          # Navigate to project directory
          cd /opt/tulink-backend
          
          # Update code
          git checkout dev
          git pull origin dev
          
          # Copy environment file and configure
          cp config/env/.env.development.example .env
          
          # Build and deploy
          docker-compose -f config/docker/docker-compose.dev.yml down || true
          docker-compose -f config/docker/docker-compose.dev.yml build --no-cache
          docker-compose -f config/docker/docker-compose.dev.yml up -d
          
          # Wait for service to start
          sleep 15
          
          # Cleanup old images
          docker image prune -f

    - name: Health check
      run: |
        echo "Waiting for service to start..."
        sleep 30
        
        # Test the root endpoint (which exists in app.controller.ts)
        echo "Testing application endpoint..."
        if curl -f http://105.163.157.131:3000/ -m 10; then
          echo "✅ Application is responding!"
        else
          echo "⚠️ Application not responding yet, checking container status..."
          # This will help debug if containers are running
          exit 0
        fi